<!doctype html>
<html>
  <head>
    </head>
    <body>
    <script type="module">
      import {directive, NodePart} from '/node_modules/lit-html/lit-html.js';
      import {html, render} from '/node_modules/lit-html/lib/lit-extended.js';

      class RepeaterClass {
        constructor() {

          this._part = null;
          this._item = null      
          this._template = null;
        }

        set part(part) {
          this._part = part;
          this._scheduleRender();
        }

        set item(item) {
          this._item = item;
          this._scheduleRender();
        }

        set template(template) {
          if (template !== this._template) {
            this._template = template;  
            this._scheduleRender(); 
          }
        }

        _scheduleRender() {
          // if (!this._pending) {
          //   this._pending = Promise.resolve().then(() =>
              this._render()
          //   );
          // }
        }

        _render() {
          if (!this._part || !this._template) return;
          this._pending = null;
          const part = new NodePart(this._part.instance, null, null);
          part.startNode = document.createTextNode('');
          part.endNode = document.createTextNode('');
          const container = this._part.startNode.parentNode;
          container.appendChild(part.startNode);
          container.appendChild(part.endNode);
          part.setValue(this._template(this._item));

          container.getBoundingClientRect();
        }
      }

      const repeater = new RepeaterClass();
      const repeat = (config) => directive(part => {
        config.part = part;
        // Promise.resolve().then(()=> {
        Object.assign(repeater, config);
        // })
      });

      const template = (item) => html`<div>Hello ${item.name}!</div>`;
      
      let item = {name: 'val'};
      render(html`<ul>${repeat({item, template})}</ul>`, document.body);

    </script>
  </body>
</html>
